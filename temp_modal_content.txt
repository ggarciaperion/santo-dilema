            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
              <div className="bg-gray-900 rounded-xl border-2 border-fuchsia-500 p-4 max-w-5xl w-full max-h-[95vh] overflow-y-auto" style={{ position: 'relative' }}>
                <h3 className="text-xl font-black text-fuchsia-400 mb-3">ÐY"Ý Registrar Nueva Compra</h3>

                {/* InformaciÇün Compacta en Grid */}
                <div className="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
                  <div>
                    <label className="block text-xs font-bold text-gray-400 mb-1">RUC</label>
                    <input
                      type="text"
                      value={inventoryForm.supplierRuc}
                      onChange={(e) => setInventoryForm({ ...inventoryForm, supplierRuc: e.target.value })}
                      className="w-full px-2 py-1.5 text-sm rounded bg-black border border-gray-700 text-white focus:border-fuchsia-400 focus:outline-none"
                      placeholder="20123456789"
                      maxLength={11}
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-fuchsia-400 mb-1">Nombre del proveedor *</label>
                    <input
                      type="text"
                      value={inventoryForm.supplier}
                      onChange={(e) => setInventoryForm({ ...inventoryForm, supplier: e.target.value.toUpperCase() })}
                      className="w-full px-2 py-1.5 text-sm rounded bg-black border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none"
                      placeholder="Nombre proveedor"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-gray-400 mb-1">TelÇ¸fono</label>
                    <input
                      type="tel"
                      value={inventoryForm.supplierPhone}
                      onChange={(e) => {
                        const value = e.target.value.replace(/\D/g, '');
                        setInventoryForm({ ...inventoryForm, supplierPhone: value });
                      }}
                      className="w-full px-2 py-1.5 text-sm rounded bg-black border border-gray-700 text-white focus:border-fuchsia-400 focus:outline-none"
                      maxLength={9}
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-fuchsia-400 mb-1">Fecha de compra *</label>
                    <input
                      type="date"
                      value={inventoryForm.purchaseDate}
                      onChange={(e) => setInventoryForm({ ...inventoryForm, purchaseDate: e.target.value })}
                      className="w-full px-2 py-1.5 text-sm rounded bg-black border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none [color-scheme:dark]"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-fuchsia-400 mb-1">MÇ¸todo de pago *</label>
                    <select
                      value={inventoryForm.paymentMethod}
                      onChange={(e) => setInventoryForm({ ...inventoryForm, paymentMethod: e.target.value })}
                      className="w-full px-2 py-1.5 text-sm rounded bg-black border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none"
                    >
                      <option value="plin-yape">ÐY"ñ Plin / Yape</option>
                      <option value="efectivo">ÐY'æ Efectivo</option>
                      <option value="transferencia">ÐY?Ý Transferencia</option>
                      <option value="tarjeta">ÐY'ü Tarjeta</option>
                    </select>
                  </div>
                </div>

                {/* Lista de ArtÇðculos */}
                <div className="mb-3">
                  <div className="flex justify-between items-center mb-2">
                    <h4 className="text-sm font-bold text-white">ÐY"< ArtÇðculos</h4>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setShowNewMaterialForm(!showNewMaterialForm)}
                        className="bg-amber-600 hover:bg-amber-500 text-white px-3 py-1 rounded text-xs font-bold transition-all"
                      >
                        + Nuevo Material
                      </button>
                      <button
                        onClick={addInventoryItem}
                        className="bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-1 rounded text-xs font-bold transition-all"
                      >
                        + Item
                      </button>
                    </div>
                  </div>

                  {/* Formulario para nuevo material */}
                  {showNewMaterialForm && (
                    <div className="bg-gray-900 rounded-lg p-3 mb-3 border border-amber-500/30">
                      <p className="text-sm font-bold text-amber-400 mb-2">Agregar Nuevo Material al CatÇ­logo</p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                        <div>
                          <label className="block text-xs font-bold text-gray-400 mb-1">Nombre del Material *</label>
                          <input
                            type="text"
                            placeholder="Ej: TENEDORES TRANSPARENTES"
                            value={newMaterialForm.productName}
                            onChange={(e) => setNewMaterialForm({ ...newMaterialForm, productName: e.target.value.toUpperCase() })}
                            className="w-full px-2 py-1.5 text-sm rounded bg-black border border-amber-500/30 text-white focus:border-amber-400 focus:outline-none"
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-gray-400 mb-1">Unidad de Medida *</label>
                          <select
                            value={newMaterialForm.unit}
                            onChange={(e) => setNewMaterialForm({ ...newMaterialForm, unit: e.target.value })}
                            className="w-full px-2 py-1.5 text-sm rounded bg-black border border-amber-500/30 text-white focus:border-amber-400 focus:outline-none"
                          >
                            <option value="">Seleccionar...</option>
                            <option value="UNIDAD">UNIDAD</option>
                            <option value="KG">KG</option>
                            <option value="LITROS">LITROS</option>
                            <option value="GRAMOS">GRAMOS</option>
                            <option value="CIENTO">CIENTO</option>
                            <option value="MEDIO MILLAR">MEDIO MILLAR</option>
                            <option value="MILLAR">MILLAR</option>
                            <option value="PAQUETE">PAQUETE</option>
                            <option value="CAJA">CAJA</option>
                            <option value="BOLSA">BOLSA</option>
                            <option value="BALDE">BALDE</option>
                          </select>
                        </div>
                        <div className="flex items-end gap-2">
                          <button
                            onClick={() => {
                              setShowNewMaterialForm(false);
                              setNewMaterialForm({ productName: "", unit: "" });
                            }}
                            className="flex-1 px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 text-white rounded font-bold transition-all"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={async () => {
                              if (newMaterialForm.productName && newMaterialForm.unit) {
                                try {
                                  // Crear el material en el catÇ­logo de productos
                                  const response = await fetch("/api/products", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({
                                      name: newMaterialForm.productName,
                                      category: "EMPAQUE", // CategorÇða por defecto
                                      unit: newMaterialForm.unit,
                                      price: 0,
                                      cost: 0,
                                      active: true,
                                      stock: 0,
                                      minStock: 10,
                                      maxStock: 100,
                                    }),
                                  });

                                  if (response.ok) {
                                    await loadCatalogProducts(); // Recargar catÇ­logo
                                    setShowNewMaterialForm(false);
                                    setNewMaterialForm({ productName: "", unit: "" });
                                    alert(`ƒo. Material "${newMaterialForm.productName}" agregado al catÇ­logo`);
                                  }
                                } catch (error) {
                                  console.error("Error al crear material:", error);
                                  alert("Error al crear el material");
                                }
                              }
                            }}
                            className="flex-1 px-3 py-1.5 text-sm bg-amber-600 hover:bg-amber-500 text-white rounded font-bold transition-all"
                          >
                            Crear Material
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Encabezados de columnas */}
                  <div className="hidden md:grid grid-cols-12 gap-2 mb-2 px-2">
                    <div className="col-span-3">
                      <p className="text-xs font-bold text-gray-400">Producto</p>
                    </div>
                    <div className="col-span-1">
                      <p className="text-xs font-bold text-gray-400">Cantidad</p>
                    </div>
                    <div className="col-span-2">
                      <p className="text-xs font-bold text-gray-400">Unidad de medida</p>
                    </div>
                    <div className="col-span-2">
                      <p className="text-xs font-bold text-gray-400">Volumen</p>
                    </div>
                    <div className="col-span-2">
                      <p className="text-xs font-bold text-gray-400">Costo total</p>
                    </div>
                    <div className="col-span-2">
                      <p className="text-xs font-bold text-gray-400">Costo unitario</p>
                    </div>
                  </div>

                  <div className="space-y-2 pr-1">
                    {inventoryForm.items.map((item, idx) => (
                      <div key={idx} className="bg-black/50 rounded p-2 border border-fuchsia-500/20">
                        <div className="grid grid-cols-12 gap-2">
                          {/* Producto */}
                          <div className="col-span-12 md:col-span-3 relative product-autocomplete">
                            <label className="block md:hidden text-xs font-bold text-gray-400 mb-1">Producto</label>
                            <input
                              type="text"
                              value={item.productName || ""}
                              onChange={(e) => {
                                console.log('ÐY"¾ onChange ejecutado:', e.target.value);
                                updateInventoryItem(idx, 'productName', e.target.value);
                                const newSearchTerms = [...productSearchTerms];
                                newSearchTerms[idx] = e.target.value;
                                setProductSearchTerms(newSearchTerms);
                                setActiveDropdownIndex(idx);
                              }}
                              onFocus={() => {
                                console.log('ÐY"¾ onFocus ejecutado, idx:', idx);
                                setActiveDropdownIndex(idx);
                              }}
                              placeholder="Escribir o seleccionar producto *"
                              className="w-full px-2 py-1 text-xs rounded bg-gray-900 border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none"
                            />
                            {activeDropdownIndex === idx && (item.productName?.length >= 3 || !item.productName) && (
                              <div className="absolute z-[200] w-full mt-1 bg-gray-800 border border-fuchsia-500/30 rounded max-h-40 overflow-y-auto shadow-2xl" style={{ position: 'absolute' }}>
                                {(() => {
                                  const searchTerm = item.productName?.toLowerCase() || "";

                                  // Obtener materiales Ç§nicos del inventario (compras registradas)
                                  const materialsMap = new Map<string, { productName: string; unit: string; productId?: string }>();

                                  inventory.forEach((purchase: any) => {
                                    purchase.items.forEach((purchaseItem: any) => {
                                      const key = `${purchaseItem.productName}-${purchaseItem.unit}`;
                                      if (!materialsMap.has(key)) {
                                        materialsMap.set(key, {
                                          productName: purchaseItem.productName,
                                          unit: purchaseItem.unit,
                                        });
                                      }
                                    });
                                  });

                                  // TambiÇ¸n agregar materiales del catÇ­logo con categorÇða de inventario
                                  const materialCategories = ['EMPAQUE', 'INSUMO', 'SERVICIO', 'COSTO FIJO', 'UTENCILIO'];
                                  catalogProducts.forEach((product: any) => {
                                    if (materialCategories.includes(product.category)) {
                                      const key = `${product.name}-${product.unit}`;
                                      if (!materialsMap.has(key)) {
                                        materialsMap.set(key, {
                                          productName: product.name,
                                          unit: product.unit,
                                          productId: product.productId,
                                        });
                                      }
                                    }
                                  });

                                  // Convertir a array y filtrar por bÇ§squeda
                                  const allMaterials = Array.from(materialsMap.values());
                                  const filteredProducts = searchTerm.length >= 3
                                    ? allMaterials.filter(m =>
                                        m.productName.toLowerCase().includes(searchTerm) ||
                                        m.productId?.toLowerCase().includes(searchTerm)
                                      )
                                    : allMaterials;

                                  // Ordenar alfabÇ¸ticamente
                                  filteredProducts.sort((a, b) => a.productName.localeCompare(b.productName));

                                  if (filteredProducts.length === 0) {
                                    return (
                                      <div className="px-3 py-2 text-xs text-gray-400">
                                        No se encontraron materiales
                                      </div>
                                    );
                                  }

                                  return filteredProducts.map((material, materialIdx) => (
                                    <div
                                      key={`${material.productName}-${material.unit}-${materialIdx}`}
                                      onMouseDown={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        console.log('ÐY"¾ onMouseDown - Material a seleccionar:', material.productName);

                                        // Actualizar el nombre del producto y la unidad
                                        const newItems = [...inventoryForm.items];
                                        newItems[idx] = {
                                          ...newItems[idx],
                                          productName: material.productName,
                                          unit: material.unit
                                        };

                                        setInventoryForm({ ...inventoryForm, items: newItems });

                                        // Actualizar searchTerms
                                        const newSearchTerms = [...productSearchTerms];
                                        newSearchTerms[idx] = material.productName;
                                        setProductSearchTerms(newSearchTerms);

                                        // Cerrar dropdown
                                        setActiveDropdownIndex(null);

                                        console.log('ÐY"¾ Material guardado:', material.productName);
                                      }}
                                      className="px-3 py-2 text-xs text-white hover:bg-fuchsia-500/20 cursor-pointer border-b border-fuchsia-500/10 last:border-b-0"
                                    >
                                      <div className="font-bold">{material.productName}</div>
                                      <div className="text-cyan-400 text-[10px] mt-0.5">
                                        {material.productId && `ID: ${material.productId} ƒ?½ `}
                                        Unidad: {material.unit}
                                      </div>
                                    </div>
                                  ));
                                })()}
                              </div>
                            )}
                          </div>
                          {/* Cantidad */}
                          <div className="col-span-6 md:col-span-1">
                            <label className="block md:hidden text-xs font-bold text-gray-400 mb-1">Cantidad</label>
                            <input
                              type="number"
                              step="0.01"
                              value={item.quantity === 0 ? '' : item.quantity}
                              onChange={(e) => updateInventoryItem(idx, 'quantity', parseFloat(e.target.value) || 0)}
                              className="w-full px-2 py-1 text-xs rounded bg-gray-900 border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                              placeholder="0"
                            />
                          </div>
                          {/* Unidad */}
                          <div className="col-span-6 md:col-span-2">
                            <label className="block md:hidden text-xs font-bold text-gray-400 mb-1">Unidad de medida</label>
                            <select
                              value={item.unit}
                              onChange={(e) => updateInventoryItem(idx, 'unit', e.target.value)}
                              className="w-full px-2 py-1 text-xs rounded bg-gray-900 border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none"
                            >
                              <option value="">Seleccionar</option>
                              <option value="UNIDAD">UNIDAD</option>
                              <option value="KG">KG</option>
                              <option value="LITROS">LITROS</option>
                              <option value="GRAMOS">GRAMOS</option>
                              <option value="SERVICIO">SERVICIO</option>
                              <option value="CIENTO">CIENTO</option>
                              <option value="MEDIO MILLAR">MEDIO MILLAR</option>
                              <option value="MILLAR">MILLAR</option>
                              <option value="PAQUETE">PAQUETE</option>
                              <option value="CAJA">CAJA</option>
                              <option value="BOLSA">BOLSA</option>
                              <option value="BALDE">BALDE</option>
                            </select>
                          </div>
                          {/* Volumen */}
                          <div className="col-span-6 md:col-span-2">
                            <label className="block md:hidden text-xs font-bold text-gray-400 mb-1">Volumen (unid/pres.)</label>
                            <input
                              type="number"
                              step="1"
                              value={item.volume || ''}
                              onChange={(e) => updateInventoryItem(idx, 'volume', parseFloat(e.target.value) || 0)}
                              className="w-full px-2 py-1 text-xs rounded bg-gray-900 border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                              placeholder=""
                            />
                          </div>
                          {/* Costo total */}
                          <div className="col-span-6 md:col-span-2">
                            <label className="block md:hidden text-xs font-bold text-gray-400 mb-1">Costo total</label>
                            <input
                              type="number"
                              step="0.01"
                              value={item.unitCost === 0 ? '' : item.unitCost}
                              onChange={(e) => updateInventoryItem(idx, 'unitCost', parseFloat(e.target.value) || 0)}
                              className="w-full px-2 py-1 text-xs rounded bg-gray-900 border border-fuchsia-500/30 text-white focus:border-fuchsia-400 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                              placeholder="0"
                            />
                          </div>
                          {/* Costo unitario */}
                          <div className="col-span-6 md:col-span-2">
                            <label className="block md:hidden text-xs font-bold text-gray-400 mb-1">Costo unitario</label>
                            <input
                              type="text"
                              value={`S/ ${item.total.toFixed(2)}`}
                              disabled
                              className="w-full px-2 py-1 text-xs rounded bg-gray-800 border border-fuchsia-500/30 text-amber-400 font-bold"
                            />
                          </div>
                          {inventoryForm.items.length > 1 && (
                            <div className="col-span-12 md:col-span-0 md:flex items-center justify-center hidden">
                              <button
                                onClick={() => removeInventoryItem(idx)}
                                className="text-red-400 hover:text-red-300 text-xs"
                                title="Eliminar"
                              >
                                ƒ?O
                              </button>
                            </div>
                          )}
                        </div>
                        {inventoryForm.items.length > 1 && (
                          <div className="md:hidden mt-1 text-right">
                            <button
                              onClick={() => removeInventoryItem(idx)}
                              className="text-red-400 hover:text-red-300 text-xs"
                            >
                              ƒ?O Eliminar
                            </button>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Total */}
                <div className="bg-gradient-to-r from-fuchsia-500/10 to-purple-500/10 rounded-lg p-3 border-2 border-fuchsia-500/50 mb-3">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="text-xs text-gray-400">Total de la Compra</p>
                      <p className="text-xs text-gray-500">{inventoryForm.items.length} item(s)</p>
                    </div>
                    <div className="text-right">
                      <p className="text-2xl font-black text-fuchsia-400">
                        S/ {inventoryForm.totalAmount.toFixed(2)}
                      </p>
                      <p className="text-xs text-gray-400">{inventoryForm.paymentMethod}</p>
                    </div>
                  </div>
                </div>

                {/* Botones */}
                <div className="flex gap-2">
                  <button
                    onClick={() => {
                      setShowInventoryModal(false);
                      setInventoryForm({
                        supplier: "",
                        supplierRuc: "",
                        supplierPhone: "",
                        paymentMethod: "plin-yape",
                        items: [{ productName: "", quantity: 0, unit: "kg", volume: 0, unitCost: 0, total: 0 }],
                        totalAmount: 0,
                        purchaseDate: new Date().toISOString().split('T')[0]
                      });
                      setProductSearchTerms([""]);
                      setActiveDropdownIndex(null);
                    }}
                    className="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 text-sm rounded-lg font-bold transition-all"
                  >
                    ƒ?O Cancelar
                  </button>
                  <button
                    onClick={handleCreateInventory}
                    className="flex-1 bg-gradient-to-r from-fuchsia-600 to-purple-600 hover:from-fuchsia-500 hover:to-purple-500 text-white px-4 py-2 text-sm rounded-lg font-bold transition-all neon-border-purple transform hover:scale-105"
                  >
                    ƒo. Registrar Compra
                  </button>
                </div>
              </div>
            </div>
          )}
        </>

